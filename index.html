<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reconhecimento Facial</title>
    <!-- Inclui o framework CSS Tailwind e a fonte Inter -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- √çcones de Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos globais e da interface escura */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Fundo escuro */
            color: #e0e0e0;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #6a2a9a, #4e1a80); /* Gradiente para o topo da p√°gina */
            border-radius: 1rem;
        }
        
        /* Estilos para as se√ß√µes principais */
        .card {
            background-color: #2c2c54;
            border: 1px solid #3d3d6e;
        }
        
        .nav-item {
            background-color: transparent;
            border: 1px solid transparent;
        }

        .nav-item.active {
            background-color: #2c2c54;
            border: 1px solid #3d3d6e;
            border-bottom: none;
            color: #ffffff;
        }
        
        .input-field {
            background-color: #3e3e7a;
            border: 1px solid #5a5a8f;
            color: #e0e0e0;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4 / 3;
            margin-left: auto;
            margin-right: auto;
        }

        .camera-container video, .camera-container canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
            transform: scaleX(-1); /* Espelha o v√≠deo horizontalmente */
        }

        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            font-weight: bold;
            color: white;
            border-radius: 1rem;
            z-index: 10;
        }
        
        .file-input-wrapper {
            position: relative;
            cursor: pointer;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header com logo e nome do sistema -->
        <header class="flex items-center justify-between p-4 mb-4">
            <div class="flex items-center space-x-2 text-white">
                <i class="fas fa-face-awesome text-4xl text-[#7a48d8]"></i>
                <h1 class="text-3xl font-bold">FaceSchool</h1>
            </div>
            <p class="text-gray-400 hidden md:block">Sistema avan√ßado de reconhecimento facial</p>
        </header>

        <!-- Barra de navega√ß√£o com os diferentes modos -->
        <nav class="flex space-x-1 border-b border-[#3d3d6e] mb-6">
            <button class="nav-item flex-1 py-3 px-6 rounded-t-xl transition duration-300 active" data-section="register-section">
                <i class="fas fa-user-plus mr-2"></i> Cadastrar
            </button>
            <button class="nav-item flex-1 py-3 px-6 rounded-t-xl transition duration-300" data-section="recognize-section">
                <i class="fas fa-camera mr-2"></i> Reconhecer
            </button>
            <button class="nav-item flex-1 py-3 px-6 rounded-t-xl transition duration-300" data-section="history-section">
                <i class="fas fa-history mr-2"></i> Hist√≥rico
            </button>
            <button class="nav-item flex-1 py-3 px-6 rounded-t-xl transition duration-300" data-section="database-section">
                <i class="fas fa-database mr-2"></i> Banco de Dados
            </button>
        </nav>

        <!-- Container principal do conte√∫do -->
        <main class="grid grid-cols-1 md:grid-cols-2 gap-8" id="content-container">
            <!-- Se√ß√£o de Cadastro de Pessoa (Vis√≠vel por padr√£o) -->
            <section id="register-section" class="card rounded-2xl shadow-lg p-6 md:p-8">
                <div class="flex items-center space-x-4 mb-6">
                    <i class="fas fa-user-plus text-3xl text-[#b381ec]"></i>
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Cadastrar Pessoa</h2>
                        <p class="text-sm text-gray-400">Adicione uma nova pessoa ao sistema de reconhecimento</p>
                    </div>
                </div>

                <form id="register-form" class="space-y-6">
                    <div>
                        <label for="person-name" class="block text-sm font-medium text-gray-400 mb-1">Nome completo</label>
                        <input type="text" id="person-name" placeholder="Digite o nome da pessoa" required
                               class="input-field w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="person-class" class="block text-sm font-medium text-gray-400 mb-1">Turma</label>
                        <input type="text" id="person-class" placeholder="Ex: 3¬∫A, Turma S, etc."
                               class="input-field w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="person-image-input" class="block text-sm font-medium text-gray-400 mb-1">Foto</label>
                        <div class="file-input-wrapper w-full h-40 bg-[#3e3e7a] border-2 border-dashed border-[#5a5a8f] rounded-lg flex flex-col items-center justify-center hover:border-purple-500 transition-colors duration-300">
                            <input type="file" id="person-image-input" accept="image/*" class="absolute inset-0 opacity-0" required>
                            <i class="fas fa-camera text-3xl text-gray-500 mb-2"></i>
                            <span class="text-gray-400 text-sm">Clique para selecionar uma imagem</span>
                        </div>
                    </div>
                    <div id="register-status" class="mt-4 p-3 text-center rounded-lg hidden"></div>
                    <button type="submit" class="w-full bg-[#7a48d8] hover:bg-[#6a2a9a] text-white font-semibold py-4 rounded-xl shadow-md transition-colors duration-300">
                        <i class="fas fa-check-circle mr-2"></i> Cadastrar Pessoa
                    </button>
                </form>
            </section>

            <!-- Se√ß√£o de Reconhecimento Facial (Escondida por padr√£o) -->
            <section id="recognize-section" class="card rounded-2xl shadow-lg p-6 md:p-8 hidden">
                <div class="flex items-center space-x-4 mb-6">
                    <i class="fas fa-camera text-3xl text-[#b381ec]"></i>
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Reconhecimento Facial</h2>
                        <p class="text-sm text-gray-400">Posicione o rosto na frente da c√¢mera para ser reconhecido.</p>
                    </div>
                </div>
                <div class="camera-container mb-6">
                    <video id="video-recognize" class="w-full h-full" autoplay playsinline></video>
                    <canvas id="canvas-recognize" class="absolute top-0 left-0 w-full h-full" style="display: none;"></canvas>
                    <div id="countdown-overlay" class="countdown-overlay hidden">3</div>
                </div>
                <div id="recognize-status" class="p-4 text-center rounded-lg hidden"></div>
            </section>

            <!-- Se√ß√£o de Hist√≥rico de Acessos (Escondida por padr√£o) -->
            <section id="history-section" class="card rounded-2xl shadow-lg p-6 md:p-8 hidden">
                <div class="flex items-center space-x-4 mb-6">
                    <i class="fas fa-history text-3xl text-[#b381ec]"></i>
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Hist√≥rico de Acessos</h2>
                        <p class="text-sm text-gray-400">Verifique o registro de acessos e gere relat√≥rios.</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="date" id="start-date" class="input-field flex-1 p-3 rounded-lg">
                        <input type="date" id="end-date" class="input-field flex-1 p-3 rounded-lg">
                    </div>
                    <button id="filter-history-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors duration-300">
                        <i class="fas fa-filter mr-2"></i> Filtrar por Per√≠odo
                    </button>
                    <div class="flex justify-between space-x-2 mt-4">
                        <button id="export-xls-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition-colors duration-300">
                            Exportar XLS
                        </button>
                        <button id="export-csv-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition-colors duration-300">
                            Exportar CSV
                        </button>
                        <button id="export-pdf-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition-colors duration-300">
                            Exportar PDF
                        </button>
                    </div>
                    <ul id="log-list" class="list-none w-full space-y-2 mt-4 max-h-96 overflow-y-auto"></ul>
                </div>
            </section>

            <!-- Se√ß√£o de Banco de Dados (Escondida por padr√£o) -->
            <section id="database-section" class="card rounded-2xl shadow-lg p-6 md:p-8 hidden">
                <div class="flex items-center space-x-4 mb-6">
                    <i class="fas fa-database text-3xl text-[#b381ec]"></i>
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Banco de Dados</h2>
                        <p class="text-sm text-gray-400">Visualize e filtre os usu√°rios cadastrados.</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="filter-name" placeholder="Buscar por nome" class="input-field flex-1 p-3 rounded-lg">
                        <input type="text" id="filter-class" placeholder="Buscar por turma" class="input-field flex-1 p-3 rounded-lg">
                    </div>
                    <div id="db-list-container" class="log-list-container flex items-center justify-center p-6 text-gray-400 rounded-lg border border-dashed border-[#5a5a8f]">
                        <div class="text-center">
                            <i class="fas fa-users text-5xl mb-4 text-gray-600"></i>
                            <p class="text-sm">Nenhuma pessoa encontrada</p>
                        </div>
                        <ul id="db-list" class="list-none w-full space-y-2 hidden"></ul>
                    </div>
                </div>
            </section>

            <!-- Se√ß√£o de Pessoas Recentes (Sempre vis√≠vel no layout, mas pode ser atualizada via JS) -->
            <section id="people-section" class="card rounded-2xl shadow-lg p-6 md:p-8 hidden">
                <h2 class="text-2xl font-semibold text-white mb-4">Pessoas Recentes</h2>
                <div id="people-list-container" class="log-list-container flex items-center justify-center p-6 text-gray-400 rounded-lg border border-dashed border-[#5a5a8f]">
                    <div class="text-center">
                        <i class="fas fa-users text-5xl mb-4 text-gray-600"></i>
                        <p class="text-sm">Nenhuma pessoa cadastrada ainda</p>
                    </div>
                    <ul id="people-list" class="list-none w-full space-y-2 hidden"></ul>
                </div>
            </section>
        </main>
    </div>

    <!-- Script JavaScript para a funcionalidade -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ [INIT] Aplica√ß√£o iniciada');
            console.log(`üåê [INIT] User Agent: ${navigator.userAgent}`);
            console.log(`üîí [INIT] Protocolo: ${window.location.protocol}`);
            console.log(`üè† [INIT] Host: ${window.location.host}`);
            console.log(`üì± [INIT] Viewport: ${window.innerWidth}x${window.innerHeight}`);
            
            const API_URL = 'https://192.168.1.103:5000'; // Backend HTTPS agora que temos certificados
            console.log(`üîó [INIT] API URL configurada: ${API_URL}`);
            
            // Verifica se estamos em HTTPS
            if (window.location.protocol === 'https:') {
                console.log('üîê [INIT] Aplica√ß√£o rodando em HTTPS - c√¢mera permitida');
            } else {
                console.warn('‚ö†Ô∏è [INIT] Aplica√ß√£o rodando em HTTP - c√¢mera pode ser bloqueada');
            }
            
            // Verifica suporte a getUserMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('‚úÖ [INIT] getUserMedia dispon√≠vel');
            } else {
                console.error('‚ùå [INIT] getUserMedia N√ÉO dispon√≠vel');
            }
            
            // Vari√°veis globais
            let stream = null;
            let countdownInterval = null;
            let currentPersonData = []; // Cache dos dados de pessoas para o filtro
            let currentLogData = [];    // Cache dos dados de log para o filtro

            // Elementos do DOM
            const navButtons = document.querySelectorAll('.nav-item');
            const sections = {
                'register-section': document.getElementById('register-section'),
                'recognize-section': document.getElementById('recognize-section'),
                'history-section': document.getElementById('history-section'),
                'database-section': document.getElementById('database-section'),
                'people-section': document.getElementById('people-section')
            };

            // Elementos da Se√ß√£o de Reconhecer
            const videoRecognize = document.getElementById('video-recognize');
            const canvasRecognize = document.getElementById('canvas-recognize');
            const recognizeStatus = document.getElementById('recognize-status');
            const countdownOverlay = document.getElementById('countdown-overlay');

            // Elementos da Se√ß√£o de Hist√≥rico
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const filterHistoryBtn = document.getElementById('filter-history-btn');
            const logList = document.getElementById('log-list');
            const exportXLSBtn = document.getElementById('export-xls-btn');
            const exportCSVBtn = document.getElementById('export-csv-btn');
            const exportPDFBtn = document.getElementById('export-pdf-btn');

            // Elementos da Se√ß√£o de Banco de Dados
            const filterNameInput = document.getElementById('filter-name');
            const filterClassInput = document.getElementById('filter-class');
            const dbListContainer = document.getElementById('db-list-container');
            const dbList = document.getElementById('db-list');
            
            // Elementos da Se√ß√£o de Cadastro
            const registerForm = document.getElementById('register-form');
            const registerStatus = document.getElementById('register-status');
            
            // Elementos da Se√ß√£o de Pessoas Recentes
            const peopleListContainer = document.getElementById('people-list-container');
            const peopleList = document.getElementById('people-list');

            // Fun√ß√µes de Utilit√°rio
            function showStatus(element, message, type) {
                // Se for um elemento que cont√©m outros elementos (como parentNode), cria um div de status
                if (element && element.children && element.children.length > 0) {
                    // Remove status anterior se existir
                    const existingStatus = element.querySelector('.status-message');
                    if (existingStatus) {
                        existingStatus.remove();
                    }
                    
                    // Cria novo elemento de status
                    const statusElement = document.createElement('div');
                    statusElement.className = 'status-message p-3 text-center rounded-lg';
                    statusElement.textContent = message;
                    
                    if (type === 'success') {
                        statusElement.classList.add('bg-green-600', 'text-white');
                    } else if (type === 'error') {
                        statusElement.classList.add('bg-red-600', 'text-white');
                    } else {
                        statusElement.classList.add('bg-blue-600', 'text-white');
                    }
                    
                    // Adiciona no in√≠cio do elemento
                    element.insertBefore(statusElement, element.firstChild);
                } else if (element) {
                    // Para elementos simples, funciona como antes
                    element.textContent = message;
                    element.classList.remove('hidden');
                    element.className = 'p-3 text-center rounded-lg';
                    if (type === 'success') {
                        element.classList.add('bg-green-600', 'text-white');
                    } else if (type === 'error') {
                        element.classList.add('bg-red-600', 'text-white');
                    } else {
                        element.classList.add('bg-blue-600', 'text-white');
                    }
                }
            }

            // Fun√ß√£o principal para trocar de se√ß√£o
            function switchSection(sectionId) {
                console.log(`üîÑ [SECTION] Mudando para se√ß√£o: ${sectionId}`);
                
                // Esconde todas as se√ß√µes primeiro
                Object.values(sections).forEach(section => section.classList.add('hidden'));

                // Mostra a se√ß√£o desejada
                sections[sectionId].classList.remove('hidden');

                // Atualiza a classe 'active' nos bot√µes de navega√ß√£o
                navButtons.forEach(btn => {
                    if (btn.dataset.section === sectionId) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                // A√ß√µes espec√≠ficas para cada se√ß√£o
                if (sectionId === 'recognize-section') {
                    console.log('üìπ [SECTION] Se√ß√£o de reconhecimento ativada, iniciando c√¢mera...');
                    startCamera();
                } else {
                    console.log('üõë [SECTION] Parando c√¢mera (mudan√ßa de se√ß√£o)');
                    stopCamera();
                }

                if (sectionId === 'history-section') {
                    console.log('üìö [SECTION] Se√ß√£o de hist√≥rico ativada, carregando logs...');
                    fetchAndListAccessLog();
                }

                if (sectionId === 'database-section') {
                    console.log('üóÑÔ∏è [SECTION] Se√ß√£o de banco ativada, carregando pessoas...');
                    fetchAndListPeople(true);
                }
                
                // Sempre recarrega a lista de pessoas recentes, pois √© uma se√ß√£o compartilhada
                fetchAndListPeople();
                console.log(`‚úÖ [SECTION] Mudan√ßa para ${sectionId} conclu√≠da`);
            }

            // Inicia a c√¢mera para o reconhecimento
            async function startCamera() {
                console.log('üé• [CAMERA] Iniciando fun√ß√£o startCamera()...');
                
                try {
                    // Verifica se o navegador suporta getUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('‚ùå [CAMERA] Navegador n√£o suporta getUserMedia');
                        showStatus(recognizeStatus, 'Seu navegador n√£o suporta c√¢mera. Use Chrome ou Firefox.', 'error');
                        return;
                    }

                    console.log('‚úÖ [CAMERA] getUserMedia dispon√≠vel');

                    // Primeiro tenta com configura√ß√µes mais espec√≠ficas para celular
                    const constraints = {
                        video: {
                            facingMode: 'user', // C√¢mera frontal
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                    
                    console.log('üîß [CAMERA] Tentando acesso com constraints:', constraints);
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('‚úÖ [CAMERA] Stream obtido com sucesso:', stream);
                    console.log(`üìπ [CAMERA] Tracks de v√≠deo encontrados: ${stream.getVideoTracks().length}`);
                    
                    videoRecognize.srcObject = stream;
                    console.log('üé¨ [CAMERA] Stream atribu√≠do ao elemento video');
                    
                    await videoRecognize.play();
                    console.log('‚ñ∂Ô∏è [CAMERA] V√≠deo iniciado com sucesso');
                    
                } catch (err) {
                    console.error('‚ùå [CAMERA] Erro com configura√ß√µes espec√≠ficas:', err);
                    console.log('üîÑ [CAMERA] Tentando configura√ß√£o b√°sica...');
                    
                    try {
                        // Se falhar, tenta com configura√ß√£o mais simples
                        stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        console.log('‚úÖ [CAMERA] Stream b√°sico obtido:', stream);
                        
                        videoRecognize.srcObject = stream;
                        await videoRecognize.play();
                        console.log('‚ñ∂Ô∏è [CAMERA] V√≠deo b√°sico iniciado com sucesso');
                        
                    } catch (err2) {
                        console.error('‚ùå [CAMERA] Erro fatal ao acessar c√¢mera:', err2);
                        console.log(`üì± [CAMERA] User agent: ${navigator.userAgent}`);
                        console.log(`üîí [CAMERA] Protocolo atual: ${window.location.protocol}`);
                        console.log(`üåê [CAMERA] Host atual: ${window.location.host}`);
                        
                        showStatus(recognizeStatus, 'Erro ao acessar a c√¢mera. Verifique as permiss√µes do navegador.', 'error');
                    }
                }
            }

            // Para a c√¢mera
            function stopCamera() {
                console.log('üõë [CAMERA] Parando c√¢mera...');
                
                if (stream) {
                    console.log(`üîç [CAMERA] Stream encontrado com ${stream.getTracks().length} tracks`);
                    stream.getTracks().forEach((track, index) => {
                        console.log(`üö™ [CAMERA] Parando track ${index}: ${track.kind} (${track.label})`);
                        track.stop();
                    });
                    stream = null;
                    console.log('‚úÖ [CAMERA] C√¢mera parada com sucesso');
                } else {
                    console.log('‚ÑπÔ∏è [CAMERA] Nenhum stream ativo para parar');
                }
            }

            // Fun√ß√£o para capturar a imagem e enviar para a API
            async function captureAndRecognize() {
                console.log('üì∏ [RECOGNIZE] Iniciando captura e reconhecimento...');
                
                // Desenha o frame atual do v√≠deo no canvas
                canvasRecognize.width = videoRecognize.videoWidth;
                canvasRecognize.height = videoRecognize.videoHeight;
                console.log(`üñºÔ∏è [RECOGNIZE] Dimens√µes do canvas: ${canvasRecognize.width}x${canvasRecognize.height}`);
                
                canvasRecognize.getContext('2d').drawImage(videoRecognize, 0, 0, canvasRecognize.width, canvasRecognize.height);
                console.log('üé® [RECOGNIZE] Frame capturado no canvas');

                // Converte a imagem do canvas para um formato de arquivo (Blob)
                canvasRecognize.toBlob(async (blob) => {
                    console.log(`üì¶ [RECOGNIZE] Blob criado: ${blob.size} bytes, tipo: ${blob.type}`);
                    
                    const formData = new FormData();
                    formData.append('image', blob, 'capture.png');
                    console.log('üì§ [RECOGNIZE] FormData preparado');

                    showStatus(recognizeStatus, 'Reconhecendo...', 'info');

                    try {
                        console.log(`üåê [RECOGNIZE] Enviando requisi√ß√£o para: ${API_URL}/recognize`);
                        console.log(`üîó [RECOGNIZE] M√©todo: POST, Content-Type: multipart/form-data`);
                        
                        const response = await fetch(`${API_URL}/recognize`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        console.log(`üì° [RECOGNIZE] Resposta recebida: ${response.status} ${response.statusText}`);
                        console.log(`üìã [RECOGNIZE] Headers da resposta:`, response.headers);
                        
                        const data = await response.json();
                        console.log('üìÑ [RECOGNIZE] Dados da resposta:', data);

                        if (response.ok) {
                            const result = data[0];
                            console.log(`üéØ [RECOGNIZE] Resultado do reconhecimento:`, result);
                            
                            if (result.recognized) {
                                console.log(`‚úÖ [RECOGNIZE] Pessoa reconhecida: ${result.name}`);
                                showStatus(recognizeStatus, `Ol√°, ${result.name}! Reconhecido com sucesso.`, 'success');
                            } else {
                                console.log(`‚ùå [RECOGNIZE] Pessoa n√£o reconhecida: ${result.name}`);
                                showStatus(recognizeStatus, 'Usu√°rio n√£o cadastrado.', 'error');
                            }
                        } else {
                            console.error(`‚ùå [RECOGNIZE] Erro HTTP: ${response.status}`, data);
                            showStatus(recognizeStatus, `Erro no reconhecimento: ${data.error || 'Erro desconhecido'}`, 'error');
                        }
                    } catch (error) {
                        console.error('‚ùå [RECOGNIZE] Erro de conex√£o:', error);
                        console.log(`üîç [RECOGNIZE] Tipo do erro: ${error.name}`);
                        console.log(`üìù [RECOGNIZE] Mensagem: ${error.message}`);
                        console.log(`üìä [RECOGNIZE] Stack trace:`, error.stack);
                        
                        showStatus(recognizeStatus, 'Erro de conex√£o com a API. Verifique se o servidor est√° online.', 'error');
                    } finally {
                        // Reseta a contagem regressiva para a pr√≥xima detec√ß√£o
                        countdownOverlay.classList.add('hidden');
                        console.log('üîÑ [RECOGNIZE] Processo de reconhecimento finalizado');
                    }
                }, 'image/jpeg'); // Formato mais eficiente
            }
            
            // Fun√ß√£o para lidar com o envio do formul√°rio de registro
            async function handleRegistration(event) {
                event.preventDefault();

                const personName = document.getElementById('person-name').value;
                const personImageInput = document.getElementById('person-image-input');
                const personImageFile = personImageInput.files[0];
                
                if (!personName || !personImageFile) {
                    showStatus(registerStatus, 'Por favor, preencha o nome e selecione uma imagem.', 'error');
                    return;
                }

                showStatus(registerStatus, 'Registrando...', 'info');

                const formData = new FormData();
                formData.append('name', personName);
                formData.append('image', personImageFile);

                try {
                    const response = await fetch(`${API_URL}/register_person_api`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showStatus(registerStatus, `${data.message}`, 'success');
                        registerForm.reset();
                        fetchAndListPeople(); // Atualiza a lista de pessoas
                    } else {
                        showStatus(registerStatus, `Erro no registro: ${data.error || 'Erro desconhecido'}`, 'error');
                    }
                } catch (error) {
                    console.error('Erro ao conectar com a API:', error);
                    showStatus(registerStatus, 'Erro de conex√£o com a API. Verifique se o servidor est√° online.', 'error');
                }
            }


            // Fun√ß√µes de Hist√≥rico
            async function fetchAndListAccessLog() {
                showStatus(logList.parentNode, 'Carregando hist√≥rico...', 'info');
                try {
                    const response = await fetch(`${API_URL}/access_log`);
                    if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    currentLogData = data; // Cache dos dados
                    filterAndDisplayLog();
                } catch (error) {
                    console.error('Erro ao buscar logs:', error);
                    showStatus(logList.parentNode, 'Erro ao carregar o registro de acessos. Verifique se o servidor est√° online.', 'error');
                }
            }

            function filterAndDisplayLog() {
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
                
                const filteredData = currentLogData.filter(log => {
                    const logDate = new Date(log.data_hora);
                    if (startDate && logDate < startDate) return false;
                    if (endDate && logDate > endDate) return false;
                    return true;
                });

                logList.innerHTML = ''; // Limpa a lista
                if (filteredData.length > 0) {
                    filteredData.forEach(log => {
                        const li = document.createElement('li');
                        const timestamp = new Date(log.data_hora).toLocaleString('pt-BR');
                        const status = log.reconhecido ? 'Reconhecido' : 'Desconhecido';
                        li.textContent = `${timestamp} - ${log.nome_identificado} (${status})`;
                        li.className = 'text-white p-2 bg-[#3e3e7a] rounded-lg';
                        logList.appendChild(li);
                    });
                     // Oculta o status de "Carregando"
                    if (logList.parentNode.querySelector('.p-3')) {
                        logList.parentNode.querySelector('.p-3').classList.add('hidden');
                    }
                } else {
                    showStatus(logList.parentNode, 'Nenhum registro encontrado para o per√≠odo.', 'error');
                }
            }

            function exportToCSV(data) {
                const headers = ["ID", "Nome", "Reconhecido", "Data/Hora"];
                const csvContent = "data:text/csv;charset=utf-8," 
                    + headers.join(";") + "\n" 
                    + data.map(e => `${e.id || ""};${e.nome_identificado || "N/A"};${e.reconhecido ? "Sim" : "N√£o"};${e.data_hora}`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "historico_acessos.csv");
                document.body.appendChild(link);
                link.click();
                link.remove();
            }

            // Fun√ß√µes do Banco de Dados
            async function fetchAndListPeople(updateCache = false) {
                 if (updateCache) {
                    peopleListContainer.innerHTML = `<div class="text-center">
                        <i class="fas fa-spinner fa-spin text-4xl mb-2 text-gray-500"></i>
                        <p class="text-sm">Carregando pessoas...</p>
                    </div>`;
                }

                try {
                    const response = await fetch(`${API_URL}/list_people`);
                    if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (updateCache) {
                        currentPersonData = data;
                        filterAndDisplayPeople();
                    } else {
                        // Para o caso de apenas exibir
                        displayPeople(data);
                    }
                } catch (error) {
                    console.error('Erro ao buscar pessoas:', error);
                    showStatus(peopleListContainer, 'Erro ao carregar a lista de pessoas. Verifique se o servidor est√° online.', 'error');
                }
            }

            function filterAndDisplayPeople() {
                const nameFilter = filterNameInput.value.toLowerCase();
                const classFilter = filterClassInput.value.toLowerCase();

                const filteredData = currentPersonData.filter(person => {
                    const matchesName = person.nome.toLowerCase().includes(nameFilter);
                    const matchesClass = person.turma ? person.turma.toLowerCase().includes(classFilter) : true;
                    return matchesName && matchesClass;
                });
                displayPeople(filteredData);
            }

            function displayPeople(data) {
                dbList.innerHTML = '';
                if (data.length > 0) {
                    dbList.classList.remove('hidden');
                    dbListContainer.innerHTML = '';
                    data.forEach(person => {
                        const li = document.createElement('li');
                        li.textContent = `${person.nome} - Turma: ${person.turma || 'N/A'}`;
                        li.className = 'text-white p-2 bg-[#3e3e7a] rounded-lg';
                        dbList.appendChild(li);
                    });
                    dbListContainer.appendChild(dbList);
                } else {
                    dbList.classList.add('hidden');
                    dbListContainer.innerHTML = `<div class="text-center">
                        <i class="fas fa-users text-5xl mb-4 text-gray-600"></i>
                        <p class="text-sm">Nenhuma pessoa encontrada</p>
                    </div>`;
                }
            }

            // Adiciona event listeners
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchSection(btn.dataset.section);
                });
            });

            // L√≥gica para o reconhecimento com contagem regressiva
            videoRecognize.addEventListener('play', () => {
                // Simula√ß√£o de detec√ß√£o de rosto para iniciar a contagem.
                // Na implementa√ß√£o real, voc√™ usaria uma biblioteca de detec√ß√£o facial aqui.
                const detectionLoop = setInterval(() => {
                    // if (faceDetected) {
                        clearInterval(detectionLoop);
                        startCountdown();
                    // }
                }, 1000);
            });
            
            function startCountdown() {
                let count = 3;
                countdownOverlay.textContent = count;
                countdownOverlay.classList.remove('hidden');

                countdownInterval = setInterval(() => {
                    count--;
                    countdownOverlay.textContent = count;
                    if (count === 0) {
                        clearInterval(countdownInterval);
                        captureAndRecognize();
                    }
                }, 1000);
            }

            // Event listeners de Hist√≥rico e Banco de Dados
            filterHistoryBtn.addEventListener('click', filterAndDisplayLog);
            exportCSVBtn.addEventListener('click', () => exportToCSV(currentLogData));
            // Adicione aqui a l√≥gica para os bot√µes XLS e PDF se voc√™ tiver as bibliotecas necess√°rias
            exportXLSBtn.addEventListener('click', () => showStatus(logList.parentNode, "Funcionalidade de exporta√ß√£o XLS n√£o implementada neste exemplo.", "error"));
            exportPDFBtn.addEventListener('click', () => showStatus(logList.parentNode, "Funcionalidade de exporta√ß√£o PDF n√£o implementada neste exemplo.", "error"));

            // Event listeners de filtro do Banco de Dados
            filterNameInput.addEventListener('input', filterAndDisplayPeople);
            filterClassInput.addEventListener('input', filterAndDisplayPeople);
            
            // Adiciona o event listener ao formul√°rio
            registerForm.addEventListener('submit', handleRegistration);

            // Chamada inicial para mostrar a se√ß√£o de cadastro
            switchSection('register-section');
        });
    </script>
</body>
</html>
